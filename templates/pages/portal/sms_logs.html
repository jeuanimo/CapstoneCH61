{% extends 'base.html' %}

{% block title %}SMS Logs - Message Tracking{% endblock %}

{% block content %}
<style>
    body.dark-mode .card {
        background-color: #1a2a4a;
        color: #e8edf7;
    }
    body.dark-mode .table {
        color: #e8edf7;
    }
    body.dark-mode .table thead {
        background-color: #0b1020;
        border-color: #2a4a7a;
    }
    body.dark-mode .table tbody td {
        border-color: #2a4a7a;
    }
    body.dark-mode .table tbody tr:hover {
        background-color: rgba(74, 122, 186, 0.2);
    }
    .badge {
        font-size: 0.85em;
    }
</style>

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="fas fa-list"></i> SMS Message Logs
                </h1>
                <a href="{% url 'home' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>

            {% if request.user.is_staff %}
                <p class="text-muted">
                    <i class="fas fa-info-circle"></i> Showing all SMS messages sent in the system
                </p>
            {% else %}
                <p class="text-muted">
                    <i class="fas fa-info-circle"></i> Showing SMS messages sent to you
                </p>
            {% endif %}

            <div class="card" style="box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);">
                <div class="card-body">
                    {% if sms_logs %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date/Time</th>
                                        <th>To</th>
                                        <th>Type</th>
                                        <th>Message</th>
                                        <th>Status</th>
                                        <th>Delivered</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in sms_logs %}
                                        <tr>
                                            <td>
                                                <small class="text-muted">
                                                    {{ log.created_at|date:"M d, Y H:i" }}
                                                </small>
                                            </td>
                                            <td>
                                                <i class="fas fa-phone text-primary"></i>
                                                <code>{{ log.phone_number }}</code>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    {{ log.get_sms_type_display }}
                                                </span>
                                            </td>
                                            <td>
                                                <small>{{ log.message_body|truncatewords:15 }}</small>
                                                {% if log.message_body|length > 100 %}
                                                    <br>
                                                    <button class="btn btn-sm btn-link p-0 mt-1" data-bs-toggle="collapse" data-bs-target="#message-{{ log.id }}">
                                                        View full message
                                                    </button>
                                                    <div class="collapse mt-2" id="message-{{ log.id }}">
                                                        <div class="p-2" style="background-color: rgba(0, 0, 0, 0.1); border-radius: 3px;">
                                                            {{ log.message_body }}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if log.status == 'sent' %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check-circle"></i> Sent
                                                    </span>
                                                {% elif log.status == 'delivered' %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check-double"></i> Delivered
                                                    </span>
                                                {% elif log.status == 'pending' %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-hourglass-half"></i> Pending
                                                    </span>
                                                {% elif log.status == 'failed' %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-times-circle"></i> Failed
                                                    </span>
                                                {% elif log.status == 'test' %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-flask"></i> Test
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if log.delivered_at %}
                                                    <small class="text-success">
                                                        {{ log.delivered_at|date:"M d H:i" }}
                                                    </small>
                                                {% elif log.status == 'failed' %}
                                                    <small class="text-danger">
                                                        {% if log.error_message %}
                                                            {{ log.error_message|truncatewords:5 }}
                                                        {% else %}
                                                            Unknown error
                                                        {% endif %}
                                                    </small>
                                                {% else %}
                                                    <small class="text-muted">â€”</small>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Statistics -->
                        <div class="row mt-4">
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Total SMS</h6>
                                        <h4>{{ sms_logs|length }}</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Sent/Delivered</h6>
                                        <h4 class="text-success">
                                            {% with sent_count=sms_logs|dictsort:"status"|length %}
                                                {{ sms_logs|length }}
                                            {% endwith %}
                                        </h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Failed</h6>
                                        <h4 class="text-danger">0</h4>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h6 class="card-title">Test Mode</h6>
                                        <h4 class="text-secondary">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle"></i>
                            <strong>No SMS messages found</strong>
                            <p class="mb-0 mt-2">
                                {% if request.user.is_staff %}
                                    SMS messages will appear here after you send them to members.
                                    <a href="{% url 'send_sms_alert' %}" class="alert-link">Send your first SMS alert</a>
                                {% else %}
                                    SMS messages sent to you will appear here.
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
