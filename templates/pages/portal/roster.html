{% extends 'base.html' %}
{% load static %}

{% block title %}Member Roster - Nu Gamma Sigma{% endblock %}

{% block content %}
<div class="portal-page">
    <div class="portal-header">
        <h1><i class="fas fa-users"></i> Member Roster</h1>
        <p>Connect with fellow brothers of Nu Gamma Sigma Chapter</p>
        {% if is_staff or is_officer %}
        <div class="header-actions">
            <a href="{% url 'create_member' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add New Member
            </a>
            <a href="{% url 'import_members' %}" class="btn btn-success">
                <i class="fas fa-file-upload"></i> Import from CSV
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Member Warning/Notification Banner -->
    {% include 'pages/portal/member_notification_banner.html' %}

    <!-- Bulk Actions Toolbar (Officers Only) -->
    {% if is_staff or is_officer %}
    <div class="bulk-actions-container" id="bulkActionsContainer" style="display: none;">
        <div class="bulk-actions-toolbar">
            <div class="selection-info">
                <span id="selectedCount">0</span> members selected
            </div>
            <form id="bulkActionsForm" method="post" action="{% url 'bulk_member_actions' %}">
                {% csrf_token %}
                <input type="hidden" id="memberIds" name="member_ids">
                
                <select id="bulkAction" name="action" class="form-control form-control-sm" onchange="handleBulkActionChange(this.value)">
                    <option value="">-- Select Action --</option>
                    <option value="edit">Bulk Edit</option>
                    <option value="delete">Delete Selected</option>
                </select>
                
                <button type="submit" class="btn btn-sm btn-primary" id="bulkActionBtn" disabled>
                    Apply Action
                </button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="toggleBulkActions(false)">
                    Cancel
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="roster-table-container">
        <table class="roster-table">
            <caption class="sr-only">Chapter member roster</caption>
            <thead>
                <tr>
                    {% if is_staff or is_officer %}<th class="checkbox-column"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)"></th>{% endif %}
                    <th>Photo</th>
                    <th>Name</th>
                    <th>Member #</th>
                    <th>Status</th>
                    <th>Contact</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for member in members %}
                <tr class="roster-row" data-member-id="{{ member.pk }}">
                    {% if is_staff or is_officer %}<td class="checkbox-column"><input type="checkbox" class="member-checkbox" value="{{ member.pk }}" onchange="updateBulkSelection()"></td>{% endif %}
                    <td class="member-photo">
                        {% if member.profile_image %}
                        <img src="{{ member.profile_image.url }}" alt="{{ member.user.get_full_name }}">
                        {% else %}
                        <div class="avatar-placeholder">
                            <i class="fas fa-user"></i>
                        </div>
                        {% endif %}
                    </td>
                    <td class="member-name">
                        <strong>{{ member.user.get_full_name|default:member.user.username }}</strong>
                        {% if member.line_name %}
                        <br><small class="line-name">{{ member.line_name }}</small>
                        {% endif %}
                    </td>
                    <td>{{ member.member_number }}</td>
                    <td>
                        <span class="status-badge status-{{ member.status }}">
                            {{ member.get_status_display }}
                        </span>
                    </td>
                    <td class="contact-info">
                        {% if member.phone %}
                        <div><i class="fas fa-phone"></i> {{ member.phone }}</div>
                        {% endif %}
                        <div><i class="fas fa-envelope"></i> {{ member.user.email }}</div>
                    </td>
                    <td class="actions-cell">
                        <a href="{% url 'member_profile' member.user.username %}" class="btn btn-primary btn-sm" title="View Profile">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'send_message_to' member.user.username %}" class="btn btn-secondary btn-sm" title="Send Message">
                            <i class="fas fa-envelope"></i>
                        </a>
                        {% if is_staff or is_officer %}
                        <a href="{% url 'generate_member_invitation' member.pk %}" class="btn btn-info btn-sm" title="Generate Invitation Code">
                            <i class="fas fa-ticket-alt"></i>
                        </a>
                        <a href="{% url 'edit_member' member.pk %}" class="btn btn-warning btn-sm" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'delete_member' member.pk %}" class="btn btn-danger btn-sm" data-confirm="Are you sure you want to delete this member? This will also delete their user account." title="Delete">
                            <i class="fas fa-trash"></i>
                        </a>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{% if is_staff or is_officer %}7{% else %}6{% endif %}" class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>No active members found.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
    .portal-page {
        padding: 2rem 0;
    }

    .portal-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .portal-header h1 {
        color: #164f90;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .portal-header p {
        color: #666;
        font-size: 1.1rem;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
    }

    .roster-table-container {
        overflow-x: auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
    }

    .roster-table {
        width: 100%;
        border-collapse: collapse;
    }

    .roster-table thead {
        background: linear-gradient(135deg, #2a7dd4, #164f90);
        color: white;
    }

    .roster-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .roster-table tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: background-color 0.2s ease;
    }

    .roster-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .roster-table td {
        padding: 1rem;
        vertical-align: middle;
    }

    .member-photo {
        width: 60px;
    }

    .member-photo img,
    .member-photo .avatar-placeholder {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #164f90;
    }

    .avatar-placeholder {
        background: linear-gradient(135deg, #2a7dd4, #164f90);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatar-placeholder i {
        font-size: 1.5rem;
        color: white;
    }

    .member-name {
        min-width: 180px;
    }

    .member-name strong {
        color: #164f90;
        font-size: 1rem;
    }

    .line-name {
        color: #666;
        font-style: italic;
        font-size: 0.85rem;
    }

    .status-badge {
        display: inline-block;
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .status-financial {
        background: #d4edda;
        color: #155724;
    }

    .status-financial_life_member {
        background: #fff3cd;
        color: #856404;
    }

    .status-new_member {
        background: #d1ecf1;
        color: #0c5460;
    }

    .status-non_financial,
    .status-non_financial_life_member {
        background: #f8d7da;
        color: #721c24;
    }

    .status-suspended {
        background: #e2e3e5;
        color: #383d41;
    }

    .contact-info {
        font-size: 0.9rem;
        color: #555;
        min-width: 200px;
    }

    .contact-info i {
        width: 16px;
        color: #164f90;
        margin-right: 0.5rem;
    }

    .contact-info div {
        margin: 0.25rem 0;
    }

    .actions-cell {
        white-space: nowrap;
    }

    .actions-cell .btn {
        margin: 0 0.25rem;
        padding: 0.4rem 0.8rem;
    }

    .btn-sm {
        font-size: 0.85rem;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #999;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #ccc;
        display: block;
    }

    /* Responsive */
    @media (max-width: 1200px) {
        .contact-info {
            font-size: 0.85rem;
        }
    }

    @media (max-width: 992px) {
        .roster-table {
            font-size: 0.9rem;
        }
        
        .roster-table th,
        .roster-table td {
            padding: 0.75rem 0.5rem;
        }
        
        .actions-cell .btn {
            padding: 0.3rem 0.6rem;
        }
    }

    @media (max-width: 768px) {
        .contact-info div:first-child {
            display: none;
        }
    }

    /* Dark Mode */
    body.dark-mode .portal-header h1 {
        color: #87ceeb;
    }

    body.dark-mode .portal-header p {
        color: #b0b8c8;
    }

    body.dark-mode .roster-table-container {
        background: #1a2a4a;
        box-shadow: 0 0 20px rgba(135, 206, 235, 0.3);
    }

    body.dark-mode .roster-table tbody tr {
        border-bottom: 1px solid #2d3e5f;
    }

    body.dark-mode .roster-table tbody tr:hover {
        background-color: #243657;
    }

    body.dark-mode .roster-table td {
        color: #e8eef5;
    }

    body.dark-mode .member-name strong {
        color: #87ceeb;
    }

    body.dark-mode .line-name {
        color: #b0b8c8;
    }

    body.dark-mode .contact-info {
        color: #b0b8c8;
    }

    body.dark-mode .contact-info i {
        color: #87ceeb;
    }

    body.dark-mode .status-financial {
        background: #1e4620;
        color: #7fdb8a;
    }

    body.dark-mode .status-financial_life_member {
        background: #4a3b1a;
        color: #ffd966;
    }

    body.dark-mode .status-new_member {
        background: #1a3a4a;
        color: #7dd3fc;
    }

    body.dark-mode .status-non_financial,
    body.dark-mode .status-non_financial_life_member {
        background: #4a1e1e;
        color: #f98080;
    }

    body.dark-mode .status-suspended {
        background: #2d3e5f;
        color: #b0b8c8;
    }

    /* Bulk Actions Styles */
    .checkbox-column {
        width: 50px;
        text-align: center;
    }

    .checkbox-column input[type="checkbox"] {
        cursor: pointer;
        width: 18px;
        height: 18px;
    }

    .bulk-actions-container {
        margin-bottom: 1.5rem;
        background: white;
        border: 2px solid #2a7dd4;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 10px rgba(42, 125, 212, 0.2);
    }

    .bulk-actions-toolbar {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .selection-info {
        font-weight: 600;
        color: #164f90;
        min-width: 150px;
    }

    .bulk-actions-toolbar .form-control-sm {
        min-width: 150px;
    }

    .bulk-actions-toolbar button {
        white-space: nowrap;
    }

    .roster-row.selected {
        background-color: #e3f2fd;
        font-weight: 500;
    }

    body.dark-mode .bulk-actions-container {
        background: #1a2a4a;
        border-color: #2a7dd4;
    }

    body.dark-mode .selection-info {
        color: #87ceeb;
    }

    body.dark-mode .roster-row.selected {
        background-color: #1f3f5f;
    }

    @media (max-width: 768px) {
        .bulk-actions-toolbar {
            flex-direction: column;
            align-items: stretch;
        }

        .bulk-actions-toolbar .form-control-sm,
        .bulk-actions-toolbar button {
            width: 100%;
        }

        .selection-info {
            text-align: center;
        }
    }
</style>

<script>
function updateBulkSelection() {
    const checkboxes = document.querySelectorAll('.member-checkbox:checked');
    const selectedCount = checkboxes.length;
    const bulkActionsContainer = document.getElementById('bulkActionsContainer');
    const selectedCountSpan = document.getElementById('selectedCount');
    const memberIdsInput = document.getElementById('memberIds');
    const bulkActionBtn = document.getElementById('bulkActionBtn');

    selectedCountSpan.textContent = selectedCount;
    
    // Collect IDs
    const ids = Array.from(checkboxes).map(cb => cb.value);
    memberIdsInput.value = ids.join(',');
    
    // Show/hide bulk actions container
    if (selectedCount > 0) {
        bulkActionsContainer.style.display = 'block';
        bulkActionBtn.disabled = false;
        
        // Highlight selected rows
        document.querySelectorAll('.roster-row').forEach(row => {
            const checkbox = row.querySelector('.member-checkbox');
            if (checkbox && checkbox.checked) {
                row.classList.add('selected');
            } else {
                row.classList.remove('selected');
            }
        });
    } else {
        bulkActionsContainer.style.display = 'none';
        bulkActionBtn.disabled = true;
        document.querySelectorAll('.roster-row').forEach(row => row.classList.remove('selected'));
    }
}

function toggleSelectAll(checked) {
    const checkboxes = document.querySelectorAll('.member-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checked;
    });
    updateBulkSelection();
}

function toggleBulkActions(show) {
    if (!show) {
        // Clear selection
        document.querySelectorAll('.member-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('selectAllCheckbox').checked = false;
        updateBulkSelection();
    }
}

function handleBulkActionChange(action) {
    const bulkActionBtn = document.getElementById('bulkActionBtn');
    if (action) {
        bulkActionBtn.disabled = false;
    } else {
        bulkActionBtn.disabled = true;
    }
}

// Form submission handler
document.getElementById('bulkActionsForm').addEventListener('submit', function(e) {
    const action = document.getElementById('bulkAction').value;
    const selectedCount = document.querySelectorAll('.member-checkbox:checked').length;
    
    if (!action) {
        e.preventDefault();
        alert('Please select an action');
        return;
    }
    
    if (selectedCount === 0) {
        e.preventDefault();
        alert('Please select at least one member');
        return;
    }
    
    if (action === 'delete') {
        if (!confirm(`Are you sure you want to delete ${selectedCount} member(s)? This action cannot be undone.`)) {
            e.preventDefault();
        }
    }
});
</script>
{% endblock %}
